# Apache configuration for AFT with CAC support

# Ensure SSL module is loaded
<IfModule !ssl_module>
    LoadModule ssl_module modules/mod_ssl.so
</IfModule>

Listen 443 https

<VirtualHost *:443>
    ServerName aft.foxxcyber.com
    DocumentRoot /var/www/html

    # Enable SSL
    SSLEngine on
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on

    # Server certificates
    SSLCertificateFile /etc/httpd/ssl/aft.foxxcyber.com.crt
    SSLCertificateKeyFile /etc/httpd/ssl/aft.foxxcyber.com.key

    # Client Certificate Configuration for CAC
    # Request certificates but don't require them (optional)
    SSLVerifyClient optional
    SSLVerifyDepth 4
    SSLCACertificateFile /home/foxx/aft-project/root-certs/DoD_Final_CA_Bundle.pem
    
    # Pass client certificate info to the application
    SSLOptions +StdEnvVars +ExportCertData

    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Proxy to Bun application
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Pass client certificate information as headers
    RequestHeader set X-Client-Cert-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-Client-Cert-Subject "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-Client-Cert-Issuer "%{SSL_CLIENT_I_DN}s"
    RequestHeader set X-Client-Cert-Serial "%{SSL_CLIENT_M_SERIAL}s"
    RequestHeader set X-Client-Cert-Fingerprint "%{SSL_CLIENT_CERT_FINGERPRINT}s"
    RequestHeader set X-Client-Cert-Not-Before "%{SSL_CLIENT_V_START}s"
    RequestHeader set X-Client-Cert-Not-After "%{SSL_CLIENT_V_END}s"
    RequestHeader set X-Client-Cert-PEM "%{SSL_CLIENT_CERT}s"
    
    # Proxy all requests to Bun
    ProxyPass / http://localhost:3001/
    ProxyPassReverse / http://localhost:3001/

    # Logging
    ErrorLog /var/log/httpd/aft-error.log
    CustomLog /var/log/httpd/aft-access.log combined
    
    # Log SSL info for debugging
    CustomLog /var/log/httpd/aft-ssl.log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%{SSL_CLIENT_S_DN}x\" %{SSL_CLIENT_VERIFY}x"
</VirtualHost>

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName aft.foxxcyber.com
    Redirect permanent / https://aft.foxxcyber.com/
</VirtualHost>